{% extends 'base.html' %}
{% load static %}

{% block title %}{{ repository.name }} - Repository - Open WebUI Customizer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-0">
                    <i class="fas fa-code-branch me-2"></i>{{ repository.name }}
                </h1>
                {% if repository.description %}
                <p class="text-muted mb-0">{{ repository.description }}</p>
                {% endif %}
            </div>
            <div class="btn-group">
                <a href="{% url 'repositories:update' repository.pk %}" class="btn btn-outline-primary">
                    <i class="fas fa-edit me-2"></i>Edit
                </a>
                <a href="{% url 'repositories:list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to List
                </a>
            </div>
        </div>

        <div class="row">
            <!-- Repository Details -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle me-2"></i>Repository Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-borderless">
                            <tr>
                                <th width="30%">Name:</th>
                                <td>{{ repository.name }}</td>
                            </tr>
                            <tr>
                                <th>Description:</th>
                                <td>{{ repository.description|default:"No description provided" }}</td>
                            </tr>
                            <tr>
                                <th>Repository URL:</th>
                                <td>
                                    <a href="{{ repository.repository_url }}" target="_blank" class="text-decoration-none">
                                        {{ repository.repository_url }}
                                        <i class="fas fa-external-link-alt ms-1"></i>
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>Type:</th>
                                <td>
                                    <span class="badge bg-secondary">{{ repository.get_repository_type_display }}</span>
                                </td>
                            </tr>
                            <tr>
                                <th>Branch:</th>
                                <td>{{ repository.default_branch|default:"main" }}</td>
                            </tr>
                            <tr>
                                <th>Verification Status:</th>
                                <td>
                                    {% if repository.is_verified %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>{{ repository.get_verification_status_display }}
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>{{ repository.get_verification_status_display }}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Last Commit:</th>
                                <td>
                                    {% if repository.commit_hash %}
                                        <code>{{ repository.commit_hash|truncatechars:8 }}</code>
                                        {% if repository.last_commit_date %}
                                        <br><small class="text-muted">{{ repository.last_commit_date|timesince }} ago</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">Not available</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Status:</th>
                                <td>
                                    {% if repository.is_active %}
                                        <span class="badge bg-success">Active</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                    {% if repository.is_experimental %}
                                        <span class="badge bg-warning ms-1">Experimental</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Created:</th>
                                <td>{{ repository.created_at|date:"M j, Y g:i A" }}</td>
                            </tr>
                            <tr>
                                <th>Last Updated:</th>
                                <td>{{ repository.updated_at|date:"M j, Y g:i A" }}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Recent Pipelines -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-history me-2"></i>Recent Pipelines
                        </h5>
                    </div>
                    <div class="card-body">
                        {% with pipelines=repository.pipeline_runs.all|slice:":5" %}
                        {% if pipelines %}
                        <div class="list-group list-group-flush">
                            {% for pipeline in pipelines %}
                            <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <div>
                                    <h6 class="mb-1">
                                        <a href="{% url 'pipelines:detail' pipeline.pk %}" class="text-decoration-none">
                                            Pipeline #{{ pipeline.pk }}
                                        </a>
                                    </h6>
                                    <small class="text-muted">
                                        {{ pipeline.created_at|timesince }} ago •
                                        {{ pipeline.get_output_type_display }} •
                                        {{ pipeline.get_status_display }}
                                    </small>
                                </div>
                                <span class="badge bg-{% if pipeline.status == 'completed' %}success{% elif pipeline.status == 'failed' %}danger{% elif pipeline.status == 'running' %}primary{% else %}secondary{% endif %}">
                                    {{ pipeline.get_status_display }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p class="text-muted">No pipelines have used this repository yet.</p>
                        {% endif %}
                        {% endwith %}
                    </div>
                </div>
            </div>

            <!-- Actions and Stats -->
            <div class="col-lg-4">
                <!-- Verification Status -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-shield-alt me-2"></i>Verification
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if repository.is_verified %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Verified</strong><br>
                            Repository access confirmed
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Not Verified</strong><br>
                            Repository access needs verification
                        </div>
                        {% endif %}

                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-info"
                                    hx-post="{% url 'repositories:verify' repository.pk %}"
                                    hx-target="#verification-result"
                                    hx-swap="innerHTML"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                                <i class="fas fa-check-circle me-2"></i>Verify Repository
                            </button>
                            <button class="btn btn-outline-secondary"
                                    hx-post="{% url 'repositories:sync' repository.pk %}"
                                    hx-target="#sync-result"
                                    hx-swap="innerHTML"
                                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
                                <i class="fas fa-sync me-2"></i>Sync Metadata
                            </button>
                        </div>

                        <div id="verification-result" class="mt-3"></div>
                        <div id="sync-result" class="mt-3"></div>
                    </div>
                </div>

                <!-- Statistics -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Statistics
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h4 mb-1">{{ total_pipelines }}</div>
                                <small class="text-muted">Total Pipelines</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 mb-1">{{ successful_pipelines }}</div>
                                <small class="text-muted">Successful</small>
                            </div>
                        </div>
                        <hr>
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="h4 mb-1">{{ failed_pipelines }}</div>
                                <small class="text-muted">Failed</small>
                            </div>
                            <div class="col-6">
                                <div class="h4 mb-1">{{ running_pipelines }}</div>
                                <small class="text-muted">Running</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tools me-2"></i>Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'repositories:update' repository.pk %}" class="btn btn-outline-primary">
                                <i class="fas fa-edit me-2"></i>Edit Repository
                            </a>
                            <a href="{% url 'pipelines:create' %}?repository={{ repository.pk }}" class="btn btn-outline-success">
                                <i class="fas fa-play me-2"></i>Start Pipeline
                            </a>
                            {% if repository.is_active %}
                            <button class="btn btn-outline-danger"
                                    hx-post="{% url 'repositories:delete' repository.pk %}"
                                    hx-confirm="Are you sure you want to deactivate this repository?"
                                    hx-target="body"
                                    hx-swap="innerHTML">
                                <i class="fas fa-ban me-2"></i>Deactivate
                            </button>
                            {% else %}
                            <button class="btn btn-outline-success"
                                    hx-post="{% url 'repositories:delete' repository.pk %}"
                                    hx-confirm="Are you sure you want to reactivate this repository?"
                                    hx-target="body"
                                    hx-swap="innerHTML">
                                <i class="fas fa-check me-2"></i>Reactivate
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// HTMX configuration for this page
document.addEventListener('DOMContentLoaded', function() {
    // Add any page-specific JavaScript here
});
</script>
{% endblock %}