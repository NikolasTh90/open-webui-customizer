{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - Open WebUI Customizer{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">
                    <i class="fas fa-key me-2"></i>{{ title }}
                </h4>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- Name Field -->
                    <div class="mb-3">
                        <label for="{{ form.name.id_for_label }}" class="form-label">
                            {{ form.name.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.name.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">{{ form.name.help_text }}</div>
                    </div>


                    <!-- Credential Type Field -->
                    <div class="mb-3">
                        <label for="{{ form.credential_type.id_for_label }}" class="form-label">
                            {{ form.credential_type.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.credential_type }}
                        {% if form.credential_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.credential_type.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">{{ form.credential_type.help_text }}</div>
                    </div>

                    <!-- Credential Data Field -->
                    <div class="mb-3">
                        <label for="{{ form.credential_data.id_for_label }}" class="form-label">
                            {{ form.credential_data.label }}
                            <span class="text-danger">*</span>
                        </label>
                        {{ form.credential_data }}
                        {% if form.credential_data.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.credential_data.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">{{ form.credential_data.help_text }}</div>

                        <!-- Example data based on credential type -->
                        <div id="credential-examples" class="mt-2">
                            <details class="mb-2">
                                <summary class="text-primary cursor-pointer">Show examples for different credential types</summary>
                                <div class="mt-2 p-3 bg-light rounded">
                                    <h6>Git SSH Key</h6>
                                    <pre class="small"><code>{
  "private_key": "-----BEGIN RSA PRIVATE KEY-----\n...\n-----END RSA PRIVATE KEY-----",
  "public_key": "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ... user@example.com"
}</code></pre>

                                    <h6 class="mt-3">Git HTTPS Token</h6>
                                    <pre class="small"><code>{
  "token": "ghp_your_github_token_here"
}</code></pre>

                                    <h6 class="mt-3">Git Username/Password</h6>
                                    <pre class="small"><code>{
  "username": "your_username",
  "password": "your_password"
}</code></pre>

                                    <h6 class="mt-3">Docker Hub</h6>
                                    <pre class="small"><code>{
  "username": "your_dockerhub_username",
  "password": "your_dockerhub_password"
}</code></pre>

                                    <h6 class="mt-3">AWS ECR</h6>
                                    <pre class="small"><code>{
  "access_key_id": "AKIAIOSFODNN7EXAMPLE",
  "secret_access_key": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",
  "region": "us-east-1"
}</code></pre>
                                </div>
                            </details>
                        </div>
                    </div>

                    <!-- Expires At Field -->
                    <div class="mb-3">
                        <label for="{{ form.expires_at.id_for_label }}" class="form-label">
                            {{ form.expires_at.label }}
                        </label>
                        {{ form.expires_at }}
                        {% if form.expires_at.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.expires_at.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">{{ form.expires_at.help_text }}</div>
                    </div>

                    <!-- Metadata Field -->
                    <div class="mb-3">
                        <label for="{{ form.metadata.id_for_label }}" class="form-label">
                            {{ form.metadata.label }}
                        </label>
                        {{ form.metadata }}
                        {% if form.metadata.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.metadata.errors.0 }}
                            </div>
                        {% endif %}
                        <div class="form-text">{{ form.metadata.help_text }}</div>
                    </div>

                    <!-- Form Actions -->
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'credentials:list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>{{ submit_text }}
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Security Notice -->
        <div class="alert alert-info mt-3">
            <i class="fas fa-shield-alt me-2"></i>
            <strong>Security Notice:</strong> All credential data is encrypted using AES-256-GCM encryption
            before being stored in the database. The encryption keys are managed securely and never exposed.
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Update form validation based on credential type
document.getElementById('{{ form.credential_type.id_for_label }}').addEventListener('change', function() {
    const credentialType = this.value;
    const dataField = document.getElementById('{{ form.credential_data.id_for_label }}');

    // Clear any existing validation
    dataField.setCustomValidity('');

    // Add type-specific placeholder
    const placeholders = {
        'git_ssh_key': '{"private_key": "-----BEGIN RSA PRIVATE KEY-----...-----END RSA PRIVATE KEY-----", "public_key": "ssh-rsa ..."}',
        'git_https_token': '{"token": "ghp_your_github_token_here"}',
        'git_username_password': '{"username": "your_username", "password": "your_password"}',
        'docker_hub': '{"username": "your_dockerhub_username", "password": "your_dockerhub_password"}',
        'aws_ecr': '{"access_key_id": "AKIA...", "secret_access_key": "...", "region": "us-east-1"}',
        'quay_io': '{"username": "your_quay_username", "password": "your_quay_password"}',
        'generic_registry': '{"username": "registry_username", "password": "registry_password"}',
        'api_key': '{"api_key": "your_api_key_here"}',
        'oauth_token': '{"access_token": "your_oauth_token_here"}',
        'custom': '{"key1": "value1", "key2": "value2"}'
    };

    dataField.placeholder = placeholders[credentialType] || '{"key": "value"}';
});

// Form validation
document.querySelector('form').addEventListener('submit', function(e) {
    const dataField = document.getElementById('{{ form.credential_data.id_for_label }}');

    try {
        JSON.parse(dataField.value);
        dataField.setCustomValidity('');
    } catch (error) {
        dataField.setCustomValidity('Credential data must be valid JSON');
        e.preventDefault();
        return false;
    }
});

// Format JSON on blur
document.getElementById('{{ form.credential_data.id_for_label }}').addEventListener('blur', function() {
    try {
        const parsed = JSON.parse(this.value);
        this.value = JSON.stringify(parsed, null, 2);
    } catch (error) {
        // Invalid JSON, leave as-is
    }
});
</script>
{% endblock %}